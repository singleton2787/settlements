<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Truck Settlement Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      -webkit-tap-highlight-color: transparent;
    }
    .scroll-x {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #earningsChart {
      height: 300px !important;
    }
    .error-message {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }
    .success-message {
      background-color: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
  <div class="max-w-4xl mx-auto p-4 sm:p-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-4 text-center text-blue-800">Truck Settlement Analyzer</h1>

    <!-- Status Messages -->
    <div id="status-message" class="hidden p-3 rounded mb-4"></div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">Upload Settlement PDF</label>
      <input type="file" id="file-input" accept="application/pdf" class="block w-full text-sm text-gray-700 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
      <p class="text-xs text-gray-500 mt-1">Select a PDF file containing your truck settlement information</p>
    </div>

    <div class="mb-6">
      <button id="export-btn" onclick="exportCSV()" disabled class="w-full bg-gray-400 text-white px-4 py-3 rounded-lg shadow cursor-not-allowed transition-colors">
        Export CSV (Upload PDF first)
      </button>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-xl font-semibold mb-3 text-gray-800">Summary</h2>
        <div id="summary" class="bg-white p-4 rounded-lg shadow-md text-sm">
          <p class="text-gray-500 italic">Upload a PDF to see summary</p>
        </div>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-3 text-gray-800">Quick Stats</h2>
        <div id="quick-stats" class="bg-white p-4 rounded-lg shadow-md text-sm">
          <p class="text-gray-500 italic">Upload a PDF to see statistics</p>
        </div>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-3 text-gray-800">Trip Earnings Chart</h2>
      <div class="bg-white p-4 rounded-lg shadow-md">
        <canvas id="earningsChart"></canvas>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-3 text-gray-800">Trip Breakdown</h2>
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="scroll-x">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-gray-50 border-b">
                <th class="p-3 text-left font-medium text-gray-700">Trip #</th>
                <th class="p-3 text-left font-medium text-gray-700">Dates</th>
                <th class="p-3 text-left font-medium text-gray-700">Amount</th>
                <th class="p-3 text-left font-medium text-gray-700">Details</th>
              </tr>
            </thead>
            <tbody id="trip-table">
              <tr>
                <td colspan="4" class="p-6 text-center text-gray-500 italic">Upload a PDF to see trip details</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let settlementData = null;
    let chartInstance = null;

    // Configure PDF.js worker when available
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }

    // DOM elements
    const fileInput = document.getElementById('file-input');
    const statusMessage = document.getElementById('status-message');
    const exportBtn = document.getElementById('export-btn');

    // Event listeners
    fileInput.addEventListener('change', handleFile);

    function showMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'p-3 rounded mb-4 ' + (type === 'error' ? 'error-message' : 'success-message');
      statusMessage.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(function() {
          statusMessage.classList.add('hidden');
        }, 5000);
      }
    }

    async function handleFile(event) {
      const file = event.target.files[0];
      
      if (!file) {
        return;
      }

      if (file.type !== 'application/pdf') {
        showMessage('Please select a valid PDF file.', 'error');
        return;
      }

      try {
        showMessage('Processing PDF...', 'success');
        
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        
        let textContent = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
          try {
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            const pageText = text.items.map(function(item) { return item.str; }).join(' ').replace(/\s+/g, ' ') + '\n';
            textContent += pageText;
          } catch (pageError) {
            console.warn('Error processing page ' + i + ':', pageError);
          }
        }

        if (!textContent.trim()) {
          showMessage('Could not extract text from PDF. The file may be image-based or corrupted.', 'error');
          return;
        }

        analyzeText(textContent);
        showMessage('PDF processed successfully!', 'success');
        
      } catch (error) {
        console.error('Error processing PDF:', error);
        showMessage('Error processing PDF file. Please ensure it is a valid settlement document.', 'error');
      }
    }

    function analyzeText(text) {
      try {
        const summaryEl = document.getElementById('summary');
        const quickStatsEl = document.getElementById('quick-stats');
        const tripTable = document.getElementById('trip-table');

        // Extract data with flexible patterns
        const netMatch = text.match(/(?:Net Earnings?|Net Pay|Net Amount)[^\d$]*\$?(\d+[,.]?\d*\.?\d+)/i);
        const milesMatch = text.match(/(?:Mileage|Miles?|Total Miles)[^\d]*(\d+[,.]?\d*)/i);
        const grossMatch = text.match(/(?:Total Gross|Gross Taxable|Gross Earnings?)[^\d$]*\$?(\d+[,.]?\d*\.?\d+)/i);
        const reimburseMatch = text.match(/(?:Total Reimbursements?|Reimbursed)[^\d$]*\$?(\d+[,.]?\d*\.?\d+)/i);

        const netEarnings = netMatch ? parseFloat(netMatch[1].replace(/,/g, '')) : null;
        const grossEarnings = grossMatch ? parseFloat(grossMatch[1].replace(/,/g, '')) : null;
        const miles = milesMatch ? parseInt(milesMatch[1].replace(/,/g, '')) : null;
        const reimbursements = reimburseMatch ? parseFloat(reimburseMatch[1].replace(/,/g, '')) : null;

        summaryEl.innerHTML = '<div class="space-y-2">' +
          '<p><strong>Net Earnings:</strong> ' + (netEarnings ? '$' + netEarnings.toFixed(2) : 'N/A') + '</p>' +
          '<p><strong>Gross Taxable Earnings:</strong> ' + (grossEarnings ? '$' + grossEarnings.toFixed(2) : 'N/A') + '</p>' +
          '<p><strong>Miles Driven:</strong> ' + (miles ? miles.toLocaleString() + ' mi' : 'N/A') + '</p>' +
          '<p><strong>Reimbursements:</strong> ' + (reimbursements ? '$' + reimbursements.toFixed(2) : 'N/A') + '</p>' +
          '</div>';

        const ratePerMile = (netEarnings && miles) ? (netEarnings / miles) : null;
        const deductions = (grossEarnings && netEarnings) ? (grossEarnings - netEarnings) : null;

        quickStatsEl.innerHTML = '<div class="space-y-2">' +
          '<p><strong>Rate per Mile:</strong> ' + (ratePerMile ? '$' + ratePerMile.toFixed(3) : 'N/A') + '</p>' +
          '<p><strong>Total Deductions:</strong> ' + (deductions ? '$' + deductions.toFixed(2) : 'N/A') + '</p>' +
          '<p><strong>Deduction Rate:</strong> ' + ((grossEarnings && deductions) ? ((deductions/grossEarnings)*100).toFixed(1) + '%' : 'N/A') + '</p>' +
          '</div>';

        // Find trips
        const tripPattern = /(\d{6,8}):?\s*([A-Z]{3}\s*\d{1,2}\s*-\s*[A-Z]{3}\s*\d{1,2})(.*?)Total\s*\$?(\d+[,.]?\d*\.?\d+)/gis;
        const trips = [...text.matchAll(tripPattern)];
        const tripData = [];

        if (trips.length === 0) {
          tripTable.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500">No trip data found. The PDF format may not be supported.</td></tr>';
        } else {
          tripTable.innerHTML = trips.map(function(trip, index) {
            const amount = parseFloat(trip[4].replace(/,/g, ''));
            tripData.push({
              trip: trip[1],
              dates: trip[2].replace(/\s+/g, ' ').trim(),
              amount: amount,
              details: trip[3].trim().replace(/\s+/g, ' ').substring(0, 100)
            });
            
            return '<tr class="' + (index % 2 === 0 ? 'bg-gray-50' : 'bg-white') + '">' +
              '<td class="p-3 whitespace-nowrap font-mono">' + trip[1] + '</td>' +
              '<td class="p-3 whitespace-nowrap">' + trip[2].replace(/\s+/g, ' ').trim() + '</td>' +
              '<td class="p-3 whitespace-nowrap font-semibold text-green-600">$' + amount.toFixed(2) + '</td>' +
              '<td class="p-3 max-w-xs truncate">' + trip[3].trim().replace(/\s+/g, ' ').substring(0, 50) + '</td>' +
              '</tr>';
          }).join('');
        }

        renderChart(tripData);
        
        settlementData = {
          summary: {
            netEarnings: netEarnings,
            grossEarnings: grossEarnings,
            miles: miles,
            reimbursements: reimbursements,
            ratePerMile: ratePerMile,
            deductions: deductions
          },
          trips: tripData
        };

        exportBtn.disabled = false;
        exportBtn.textContent = 'Export CSV';
        exportBtn.className = 'w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors cursor-pointer';

      } catch (error) {
        console.error('Error analyzing text:', error);
        showMessage('Error analyzing PDF content. Please check if this is a valid settlement document.', 'error');
      }
    }

    function renderChart(trips) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
      }

      const ctx = document.getElementById('earningsChart').getContext('2d');
      
      if (chartInstance) {
        chartInstance.destroy();
      }

      if (trips.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.fillText('No trip data to display', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }

      try {
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: trips.map(function(t) { return 'Trip ' + t.trip; }),
            datasets: [{
              label: 'Trip Earnings ($)',
              data: trips.map(function(t) { return t.amount; }),
              backgroundColor: '#3b82f6',
              borderColor: '#1d4ed8',
              borderWidth: 1,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '$' + context.parsed.y.toFixed(2);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toFixed(0);
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating chart:', error);
      }
    }

    function exportCSV() {
      if (!settlementData) {
        showMessage('No data to export. Please upload a PDF first.', 'error');
        return;
      }

      try {
        const csvRows = ['Trip,Dates,Amount,Details'];

        settlementData.trips.forEach(function(trip) {
          const row = [
            trip.trip,
            '"' + trip.dates + '"',
            trip.amount.toFixed(2),
            '"' + trip.details.replace(/"/g, '""') + '"'
          ];
          csvRows.push(row.join(','));
        });

        csvRows.push('');
        csvRows.push('Summary');
        if (settlementData.summary.netEarnings) csvRows.push('Net Earnings,' + settlementData.summary.netEarnings.toFixed(2));
        if (settlementData.summary.grossEarnings) csvRows.push('Gross Earnings,' + settlementData.summary.grossEarnings.toFixed(2));
        if (settlementData.summary.miles) csvRows.push('Miles,' + settlementData.summary.miles);
        if (settlementData.summary.reimbursements) csvRows.push('Reimbursements,' + settlementData.summary.reimbursements.toFixed(2));

        const csv = csvRows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const fileName = 'settlement_' + new Date().toISOString().split('T')[0] + '.csv';
        saveAs(blob, fileName);
        
        showMessage('CSV exported successfully!', 'success');
      } catch (error) {
        console.error('Error exporting CSV:', error);
        showMessage('Error exporting CSV file.', 'error');
      }
    }
  </script>
</body>
</html>
