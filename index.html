<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Truck Driver Pay Settlement Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      -webkit-tap-highlight-color: transparent;
    }
    .scroll-x {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #earningsChart {
      height: 300px !important;
    }
    .error-message {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }
    .success-message {
      background-color: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      border-bottom: 1px dotted #999;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 280px;
      background-color: #1f2937;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -140px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1f2937 transparent transparent transparent;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    @media (max-width: 640px) {
      .tooltip .tooltiptext {
        width: 240px;
        margin-left: -120px;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
  <div class="max-w-4xl mx-auto p-4 sm:p-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-4 text-center text-blue-800">Truck Driver Pay Settlement Analyzer</h1>
    <p class="text-center text-gray-600 mb-6">Analyze your weekly/bi-weekly driver pay settlements</p>

    <!-- Status Messages -->
    <div id="status-message" class="hidden p-3 rounded mb-4"></div>

    <!-- Validation Status -->
    <div id="validation-status" class="mb-4"></div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">Upload Pay Settlement PDF</label>
      <input type="file" id="file-input" accept="application/pdf" class="block w-full text-sm text-gray-700 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
      <p class="text-xs text-gray-500 mt-1">Select your weekly or bi-weekly driver pay settlement PDF</p>
    </div>

    <div class="mb-6">
      <button id="export-btn" onclick="exportCSV()" disabled class="w-full bg-gray-400 text-white px-4 py-3 rounded-lg shadow cursor-not-allowed transition-colors">
        Export CSV (Upload PDF first)
      </button>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-xl font-semibold mb-3 text-gray-800">This Period Summary</h2>
        <div id="summary" class="bg-white p-4 rounded-lg shadow-md text-sm">
          <p class="text-gray-500 italic">Upload a PDF to see current period summary</p>
        </div>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-3 text-gray-800">Pay Analysis</h2>
        <div id="quick-stats" class="bg-white p-4 rounded-lg shadow-md text-sm">
          <p class="text-gray-500 italic">Upload a PDF to see pay analysis</p>
        </div>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-3 text-gray-800">Trip Earnings Chart</h2>
      <div class="bg-white p-4 rounded-lg shadow-md">
        <canvas id="earningsChart"></canvas>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-3 text-gray-800">Trip Breakdown</h2>
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="scroll-x">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-gray-50 border-b">
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Trip #
                    <span class="tooltiptext">Unique number assigned to each load or trip. Used by dispatch and billing to track your work.</span>
                  </span>
                </th>
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Dates
                    <span class="tooltiptext">When you picked up and delivered this load. Format is usually pickup date - delivery date.</span>
                  </span>
                </th>
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Amount
                    <span class="tooltiptext">How much you earned for this specific trip/load, after any company deductions but before taxes.</span>
                  </span>
                </th>
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Details
                    <span class="tooltiptext">Additional info about the load: pickup/delivery locations, mileage, special pay (detention, tarp pay, etc.).</span>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody id="trip-table">
              <tr>
                <td colspan="4" class="p-6 text-center text-gray-500 italic">Upload a PDF to see trip details</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let settlementData = null;
    let chartInstance = null;

    // PDF.js worker setup
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }

    // DOM elements
    const fileInput = document.getElementById('file-input');
    const statusMessage = document.getElementById('status-message');
    const exportBtn = document.getElementById('export-btn');
    const validationStatus = document.getElementById('validation-status');

    // Event listener
    fileInput.addEventListener('change', handleFile);

    function showMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'p-3 rounded mb-4 ' + (type === 'error' ? 'error-message' : 'success-message');
      statusMessage.classList.remove('hidden');
      if (type === 'success') {
        setTimeout(() => statusMessage.classList.add('hidden'), 5000);
      }
    }

    // Load and process PDF text content
    async function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      if (file.type !== 'application/pdf') {
        showMessage('Please select a valid PDF file.', 'error');
        return;
      }
      try {
        showMessage('Processing PDF...', 'success');
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let textContent = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          try {
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            textContent += text.items.map(item => item.str).join(' ').replace(/\s+/g, ' ') + '\n';
          } catch (e) {
            console.warn('Error processing page ' + i, e);
          }
        }
        if (!textContent.trim()) {
          showMessage('Could not extract text from PDF. The file may be image-based or corrupted.', 'error');
          return;
        }
        analyzeText(textContent);
        showMessage('PDF processed successfully!', 'success');
      } catch (err) {
        console.error(err);
        showMessage('Error processing PDF file. Please ensure it is a valid settlement document.', 'error');
      }
    }

    // Analyze parsed text, extract values, validate and display
    function analyzeText(text) {
      try {
        const summaryEl = document.getElementById('summary');
        const quickStatsEl = document.getElementById('quick-stats');
        const tripTable = document.getElementById('trip-table');

        // Parse financial info
        const grossMatch = text.match(/Total Gross Taxable Earnings[^\d$-]*\$?([-.\d,]+)/i);
        const nonTaxableMatch = text.match(/Non-Taxable Earnings[^\d$-]*\$?([-.\d,]+)/i);
        const reimburseMatch = text.match(/Total Reimbursements[^\d$-]*\$?([-.\d,]+)/i);
        const deductionsMatch = text.match(/Total Deductions[^\d$-]*\(?\$?([-.\d,]+)\)?/i);
        const netMatch = text.match(/Net Earnings[^\d$-]*\$?([-.\d,]+)/i);
        const taxesMatch = text.match(/Total Taxes[^\d$-]*\(?\$?([-.\d,]+)\)?/i);

        // Parse miles info including taxable and per diem miles
        const totalMilesMatch = text.match(/\*?Mileage\s+—\s+(\d{1,6})/i);
        const taxableMilesMatch = text.match(/(?:Taxable Miles|Taxable Mileage|Mileage \(Taxable\))\s*([-\d,]+)/i);
        const perDiemMilesMatch = text.match(/(?:Per Diem Miles|Non[- ]Taxable Miles|Non[- ]Taxable Mileage|Mileage \(Non[- ]Taxable\))\s*([-\d,]+)/i);

        const grossEarnings = grossMatch ? parseFloat(grossMatch[1].replace(/,/g, '')) : null;
        const nonTaxable = nonTaxableMatch ? parseFloat(nonTaxableMatch[1].replace(/,/g, '')) : 0;
        const reimbursements = reimburseMatch ? parseFloat(reimburseMatch[1].replace(/,/g, '')) : 0;
        const totalDeductions = deductionsMatch ? parseFloat(deductionsMatch[1].replace(/[(),]/g, '')) : null;
        const totalTaxes = taxesMatch ? parseFloat(taxesMatch[1].replace(/[(),]/g, '')) : null;
        const netEarnings = netMatch ? parseFloat(netMatch[1].replace(/,/g, '')) : null;
        const totalMiles = totalMilesMatch ? parseInt(totalMilesMatch[1].replace(/,/g, ''), 10) : null;
        const taxableMiles = taxableMilesMatch ? parseInt(taxableMilesMatch[1].replace(/,/g, ''), 10) : null;
        const perDiemMiles = perDiemMilesMatch ? parseInt(perDiemMilesMatch[1].replace(/,/g, ''), 10) : null;

        // Calculate rate per mile using taxable miles if available, else total miles
        const effectiveTaxableMiles = taxableMiles !== null ? taxableMiles : totalMiles;
        const ratePerMile = (grossEarnings && effectiveTaxableMiles) ? (grossEarnings / effectiveTaxableMiles) : null;

        // Validation of settlement math
        let validationStatusText = '';
        let validationStatusClass = '';

        if (
          grossEarnings !== null &&
          totalDeductions !== null &&
          totalTaxes !== null &&
          netEarnings !== null
        ) {
          const netCalc = grossEarnings + nonTaxable + reimbursements - totalDeductions - totalTaxes;
          const diff = Math.abs(netCalc - netEarnings);
          if (diff < 0.01) {
            validationStatusText = '✅ All Clear: Settlement math is consistent.';
            validationStatusClass = 'p-4 rounded bg-green-50 border border-green-200 text-green-700 font-semibold';
          } else if (diff < 2) {
            validationStatusText = `⚠️ Warning: Net earnings differ from calculated total by $${diff.toFixed(2)}. Check for small rounding or overrides.`;
            validationStatusClass = 'p-4 rounded bg-yellow-50 border border-yellow-200 text-yellow-700 font-semibold';
          } else {
            validationStatusText = `❌ ERROR: Net earnings differ from calculated total by $${diff.toFixed(2)}. Significant mismatch!`;
            validationStatusClass = 'p-4 rounded bg-red-50 border border-red-200 text-red-700 font-semibold';
          }
        } else {
          validationStatusText = '⚠️ Warning: Incomplete data for settlement validation.';
          validationStatusClass = 'p-4 rounded bg-yellow-50 border border-yellow-200 text-yellow-700 font-semibold';
        }

        validationStatus.innerHTML = validationStatusText;
        validationStatus.className = validationStatusClass;

        // Build summary HTML including taxable and per diem miles
        let summaryHTML = '<div class="space-y-2">';
        summaryHTML += '<p><strong><span class="tooltip">Net Earnings<span class="tooltiptext">Your actual take-home pay after all deductions (taxes, insurance, etc.).</span></span>:</strong> ' + (netEarnings ? '$' + netEarnings.toFixed(2) : 'N/A') + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Gross Taxable Earnings<span class="tooltiptext">Your total taxable pay before any deductions.</span></span>:</strong> ' + (grossEarnings ? '$' + grossEarnings.toFixed(2) : 'N/A') + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Non-Taxable (Per Diem)<span class="tooltiptext">Per diem or exempt non-taxable amount.</span></span>:</strong> ' + (nonTaxable ? '$' + nonTaxable.toFixed(2) : '$0.00') + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Taxable Miles<span class="tooltiptext">Miles counted toward taxable earnings calculation.</span></span>:</strong> ' + (taxableMiles !== null ? taxableMiles.toLocaleString() + ' mi' : (totalMiles !== null ? 'N/A (using total miles: ' + totalMiles.toLocaleString() + ' mi)' : 'N/A')) + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Non-Taxable (Per Diem) Miles<span class="tooltiptext">Miles paid as non-taxable per diem or reimbursements.</span></span>:</strong> ' + (perDiemMiles !== null ? perDiemMiles.toLocaleString() + ' mi' : 'N/A') + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Reimbursements<span class="tooltiptext">Money reimbursed for work expenses.</span></span>:</strong> ' + (reimbursements ? '$' + reimbursements.toFixed(2) : '$0.00') + '</p>';
        summaryHTML += '</div>';
        summaryEl.innerHTML = summaryHTML;

        // Build stats HTML
        let statsHTML = '<div class="space-y-2">';
        statsHTML += '<p><strong><span class="tooltip">Rate per Mile<span class="tooltiptext">Excluded non-taxable miles; based on taxable miles and gross taxable earnings.</span></span>:</strong> ' + (ratePerMile ? '$' + ratePerMile.toFixed(3) : 'N/A') + '</p>';
        statsHTML += '<p><strong><span class="tooltip">Total Deductions<span class="tooltiptext">All company/benefit deductions (not taxes).</span></span>:</strong> ' + (totalDeductions !== null ? '$' + totalDeductions.toFixed(2) : 'N/A') + '</p>';
        statsHTML += '<p><strong><span class="tooltip">Total Taxes<span class="tooltiptext">All payroll taxes withheld.</span></span>:</strong> ' + (totalTaxes !== null ? '$' + totalTaxes.toFixed(2) : 'N/A') + '</p>';
        statsHTML += '<p><strong><span class="tooltip">Deduction Rate<span class="tooltiptext">Percentage of gross taken by company deductions (not taxes).</span></span>:</strong> ' + (grossEarnings && totalDeductions !== null ? ((totalDeductions / grossEarnings) * 100).toFixed(1) + '%' : 'N/A') + '</p>';
        statsHTML += '<p><strong><span class="tooltip">Tax Rate<span class="tooltiptext">Percent of gross taken by taxes.</span></span>:</strong> ' + (grossEarnings && totalTaxes !== null ? ((totalTaxes / grossEarnings) * 100).toFixed(1) + '%' : 'N/A') + '</p>';
        statsHTML += '</div>';
        quickStatsEl.innerHTML = statsHTML;

        // Extract and show trip data
        // Regex matches trip numbers, dates, description and amount up to Total line
        const tripPatterns = [
          /(\d{6,8}):\s*([A-Z]{3}\s+\d{1,2}\s*-\s*[A-Z]{3}\s*\d{1,2})([\s\S]*?)Total\s*\$?([-\d.,]+)/gis
        ];
        let trips = [];
        for (let p = 0; p < tripPatterns.length; p++) {
          trips = Array.from(text.matchAll(tripPatterns[p]));
          if (trips.length > 0) break;
        }

        const tripData = [];
        if (trips.length === 0) {
          tripTable.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500">No trip data found. The PDF format may not be supported.</td></tr>';
        } else {
          let tableHTML = '';
          for (let i = 0; i < trips.length; i++) {
            const trip = trips[i];
            const amount = parseFloat(trip[4].replace(/,/g, ''));
            tripData.push({
              trip: trip[1],
              dates: trip[2].replace(/\s+/g, ' ').trim(),
              amount: amount,
              details: trip[3].trim().replace(/\s+/g, ' ').substring(0, 100)
            });

            tableHTML += '<tr class="' + (i % 2 === 0 ? 'bg-gray-50' : 'bg-white') + '">';
            tableHTML += '<td class="p-3 whitespace-nowrap font-mono">' + trip[1] + '</td>';
            tableHTML += '<td class="p-3 whitespace-nowrap">' + trip[2] + '</td>';
            tableHTML += '<td class="p-3 whitespace-nowrap font-semibold text-green-600">$' + amount.toFixed(2) + '</td>';
            tableHTML += '<td class="p-3 max-w-xs truncate">' + trip[3].trim().replace(/\s+/g, ' ').substring(0, 50) + '</td>';
            tableHTML += '</tr>';
          }
          tripTable.innerHTML = tableHTML;
        }

        renderChart(tripData);

        // Save parsed data for export
        settlementData = {
          summary: {
            netEarnings,
            grossEarnings,
            nonTaxable,
            miles: totalMiles,
            taxableMiles,
            perDiemMiles,
            reimbursements,
            ratePerMile,
            deductions: totalDeductions,
            taxes: totalTaxes,
          },
          trips: tripData,
        };

        exportBtn.disabled = false;
        exportBtn.textContent = 'Export CSV';
        exportBtn.className = 'w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors cursor-pointer';

      } catch (error) {
        console.error('Error analyzing text:', error);
        showMessage('Error analyzing PDF content. Please check if this is a valid settlement document.', 'error');
      }
    }

    // Render bar chart of trip earnings
    function renderChart(trips) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
      }

      const ctx = document.getElementById('earningsChart').getContext('2d');

      if (chartInstance) {
        chartInstance.destroy();
      }

      if (trips.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.fillText('No trip data to display', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }

      try {
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: trips.map(t => 'Trip ' + t.trip),
            datasets: [{
              label: 'Trip Earnings ($)',
              data: trips.map(t => t.amount),
              backgroundColor: '#3b82f6',
              borderColor: '#1d4ed8',
              borderWidth: 1,
              borderRadius: 4,
            }],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: context => '$' + context.parsed.y.toFixed(2),
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: value => '$' + value.toFixed(0),
                },
              },
            },
          },
        });
      } catch (error) {
        console.error('Error creating chart:', error);
      }
    }

    // Export CSV of trips + summary
    function exportCSV() {
      if (!settlementData) {
        showMessage('No data to export. Please upload a PDF first.', 'error');
        return;
      }

      try {
        const csvRows = ['Trip,Dates,Amount,Details'];

        settlementData.trips.forEach(trip => {
          const row = [
            trip.trip,
            `"${trip.dates}"`,
            trip.amount.toFixed(2),
            `"${trip.details.replace(/"/g, '""')}"`,
          ];
          csvRows.push(row.join(','));
        });

        csvRows.push('');
        csvRows.push('Summary');
        const s = settlementData.summary;
        if (s.netEarnings !== null) csvRows.push('Net Earnings,' + s.netEarnings.toFixed(2));
        if (s.grossEarnings !== null) csvRows.push('Gross Earnings,' + s.grossEarnings.toFixed(2));
        if (s.nonTaxable !== null) csvRows.push('Non-Taxable Per Diem,' + s.nonTaxable.toFixed(2));
        if (s.miles !== null) csvRows.push('Total Miles,' + s.miles);
        if (s.taxableMiles !== null) csvRows.push('Taxable Miles,' + s.taxableMiles);
        if (s.perDiemMiles !== null) csvRows.push('Per Diem / Non-Taxable Miles,' + s.perDiemMiles);
        if (s.reimbursements !== null) csvRows.push('Reimbursements,' + s.reimbursements.toFixed(2));
        if (s.deductions !== null) csvRows.push('Total Deductions,' + s.deductions.toFixed(2));
        if (s.taxes !== null) csvRows.push('Total Taxes,' + s.taxes.toFixed(2));

        const csv = csvRows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const fileName = 'settlement_' + new Date().toISOString().split('T')[0] + '.csv';
        saveAs(blob, fileName);

        showMessage('CSV exported successfully!', 'success');
      } catch (error) {
        console.error('Error exporting CSV:', error);
        showMessage('Error exporting CSV file.', 'error');
      }
    }
  </script>
</body>
</html>
