<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Truck Driver Pay Settlement Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      -webkit-tap-highlight-color: transparent;
    }
    .scroll-x {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #earningsChart {
      height: 300px !important;
    }
    .error-message {
      background-color: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }
    .success-message {
      background-color: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      border-bottom: 1px dotted #999;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 280px;
      background-color: #1f2937;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -140px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .tooltip .tooltiptext::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #1f2937 transparent transparent transparent;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    @media (max-width: 640px) {
      .tooltip .tooltiptext {
        width: 240px;
        margin-left: -120px;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
  <div class="max-w-4xl mx-auto p-4 sm:p-6">
    <h1 class="text-2xl sm:text-3xl font-bold mb-4 text-center text-blue-800">Truck Driver Pay Settlement Analyzer</h1>
    <p class="text-center text-gray-600 mb-6">Analyze your weekly/bi-weekly driver pay settlements</p>

    <!-- Status Messages -->
    <div id="status-message" class="hidden p-3 rounded mb-4"></div>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2">Upload Pay Settlement PDF</label>
      <input type="file" id="file-input" accept="application/pdf" class="block w-full text-sm text-gray-700 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
      <p class="text-xs text-gray-500 mt-1">Select your weekly or bi-weekly driver pay settlement PDF</p>
    </div>

    <div class="mb-6">
      <button id="export-btn" onclick="exportCSV()" disabled class="w-full bg-gray-400 text-white px-4 py-3 rounded-lg shadow cursor-not-allowed transition-colors">
        Export CSV (Upload PDF first)
      </button>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-xl font-semibold mb-3 text-gray-800">This Period Summary</h2>
        <div id="summary" class="bg-white p-4 rounded-lg shadow-md text-sm">
          <p class="text-gray-500 italic">Upload a PDF to see current period summary</p>
        </div>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-3 text-gray-800">Pay Analysis</h2>
        <div id="quick-stats" class="bg-white p-4 rounded-lg shadow-md text-sm">
          <p class="text-gray-500 italic">Upload a PDF to see pay analysis</p>
        </div>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-3 text-gray-800">Trip Earnings Chart</h2>
      <div class="bg-white p-4 rounded-lg shadow-md">
        <canvas id="earningsChart"></canvas>
      </div>
    </div>

    <div class="mt-8">
      <h2 class="text-xl font-semibold mb-3 text-gray-800">Trip Breakdown</h2>
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="scroll-x">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-gray-50 border-b">
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Trip #
                    <span class="tooltiptext">Unique number assigned to each load or trip. Used by dispatch and billing to track your work.</span>
                  </span>
                </th>
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Dates
                    <span class="tooltiptext">When you picked up and delivered this load. Format is usually pickup date - delivery date.</span>
                  </span>
                </th>
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Amount
                    <span class="tooltiptext">How much you earned for this specific trip/load, after any company deductions but before taxes.</span>
                  </span>
                </th>
                <th class="p-3 text-left font-medium text-gray-700">
                  <span class="tooltip">Details
                    <span class="tooltiptext">Additional info about the load: pickup/delivery locations, mileage, special pay (detention, tarp pay, etc.).</span>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody id="trip-table">
              <tr>
                <td colspan="4" class="p-6 text-center text-gray-500 italic">Upload a PDF to see trip details</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let settlementData = null;
    let chartInstance = null;

    // Configure PDF.js worker when available
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    }

    // DOM elements
    const fileInput = document.getElementById('file-input');
    const statusMessage = document.getElementById('status-message');
    const exportBtn = document.getElementById('export-btn');

    // Event listeners
    fileInput.addEventListener('change', handleFile);

    function showMessage(message, type) {
      statusMessage.textContent = message;
      statusMessage.className = 'p-3 rounded mb-4 ' + (type === 'error' ? 'error-message' : 'success-message');
      statusMessage.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(function() {
          statusMessage.classList.add('hidden');
        }, 5000);
      }
    }

    async function handleFile(event) {
      const file = event.target.files[0];
      
      if (!file) {
        return;
      }

      if (file.type !== 'application/pdf') {
        showMessage('Please select a valid PDF file.', 'error');
        return;
      }

      try {
        showMessage('Processing PDF...', 'success');
        
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        
        let textContent = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
          try {
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            const pageText = text.items.map(function(item) { return item.str; }).join(' ').replace(/\s+/g, ' ') + '\n';
            textContent += pageText;
          } catch (pageError) {
            console.warn('Error processing page ' + i + ':', pageError);
          }
        }

        if (!textContent.trim()) {
          showMessage('Could not extract text from PDF. The file may be image-based or corrupted.', 'error');
          return;
        }

        analyzeText(textContent);
        showMessage('PDF processed successfully!', 'success');
        
      } catch (error) {
        console.error('Error processing PDF:', error);
        showMessage('Error processing PDF file. Please ensure it is a valid settlement document.', 'error');
      }
    }

    function analyzeText(text) {
      try {
        const summaryEl = document.getElementById('summary');
        const quickStatsEl = document.getElementById('quick-stats');
        const tripTable = document.getElementById('trip-table');

        // Extract data with flexible patterns for driver pay settlements
        const netMatch = text.match(/(?:Net Earnings?|Net Pay|Net Amount|Take Home)[^\d$]*\$?(\d+[,.]?\d*\.?\d+)/i);
        const milesMatch = text.match(/(?:Mileage|Miles?|Total Miles)[^\d]*(\d+[,.]?\d*)/i);
        const grossMatch = text.match(/(?:Total Gross|Gross Taxable|Gross Earnings?|Gross Pay)[^\d$]*\$?(\d+[,.]?\d*\.?\d+)/i);
        const reimburseMatch = text.match(/(?:Total Reimbursements?|Reimbursed|Advances)[^\d$]*\$?(\d+[,.]?\d*\.?\d+)/i);

        const netEarnings = netMatch ? parseFloat(netMatch[1].replace(/,/g, '')) : null;
        const grossEarnings = grossMatch ? parseFloat(grossMatch[1].replace(/,/g, '')) : null;
        const miles = milesMatch ? parseInt(milesMatch[1].replace(/,/g, '')) : null;
        const reimbursements = reimburseMatch ? parseFloat(reimburseMatch[1].replace(/,/g, '')) : null;

        // Build summary HTML with tooltips
        let summaryHTML = '<div class="space-y-2">';
        summaryHTML += '<p><strong><span class="tooltip">Net Earnings<span class="tooltiptext">Your actual take-home pay after all deductions (taxes, insurance, truck payments, etc.). This is what goes in your pocket.</span></span>:</strong> ' + (netEarnings ? '$' + netEarnings.toFixed(2) : 'N/A') + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Gross Taxable Earnings<span class="tooltiptext">Your total pay before any deductions. This is what the company pays you before taxes and other costs are taken out.</span></span>:</strong> ' + (grossEarnings ? '$' + grossEarnings.toFixed(2) : 'N/A') + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Miles Driven<span class="tooltiptext">Total miles you drove for all trips in this settlement period. Used to calculate your rate per mile.</span></span>:</strong> ' + (miles ? miles.toLocaleString() + ' mi' : 'N/A') + '</p>';
        summaryHTML += '<p><strong><span class="tooltip">Reimbursements<span class="tooltiptext">Money the company pays you back for expenses like fuel, tolls, permits, or other out-of-pocket costs you paid while driving.</span></span>:</strong> ' + (reimbursements ? '$' + reimbursements.toFixed(2) : 'N/A') + '</p>';
        summaryHTML += '</div>';
        summaryEl.innerHTML = summaryHTML;

        const ratePerMile = (netEarnings && miles) ? (netEarnings / miles) : null;
        const deductions = (grossEarnings && netEarnings) ? (grossEarnings - netEarnings) : null;

        // Build stats HTML with tooltips
        let statsHTML = '<div class="space-y-2">';
        statsHTML += '<p><strong><span class="tooltip">Rate per Mile<span class="tooltiptext">How much you earn per mile driven (CPM = Cents Per Mile). Industry average is $0.40-$0.65 per mile. Higher is better!</span></span>:</strong> ' + (ratePerMile ? '$' + ratePerMile.toFixed(3) : 'N/A') + '</p>';
        statsHTML += '<p><strong><span class="tooltip">Total Deductions<span class="tooltiptext">Everything taken out of your gross pay: taxes, insurance, truck payments, maintenance funds, etc. The difference between gross and net pay.</span></span>:</strong> ' + (deductions ? '$' + deductions.toFixed(2) : 'N/A') + '</p>';
        statsHTML += '<p><strong><span class="tooltip">Deduction Rate<span class="tooltiptext">What percentage of your gross pay goes to deductions. Typical range is 25-40%. Lower percentages mean you keep more of your earnings.</span></span>:</strong> ' + ((grossEarnings && deductions) ? ((deductions/grossEarnings)*100).toFixed(1) + '%' : 'N/A') + '</p>';
        statsHTML += '</div>';
        quickStatsEl.innerHTML = statsHTML;

        // Find trips with multiple patterns
        const tripPatterns = [
          /(\d{6,8}):?\s*([A-Z]{3}\s*\d{1,2}\s*-\s*[A-Z]{3}\s*\d{1,2})(.*?)Total\s*\$?(\d+[,.]?\d*\.?\d+)/gis,
          /Trip\s*#?(\d+)[^\d]*([A-Z]{3}\s*\d{1,2}[^\d]*[A-Z]{3}\s*\d{1,2})(.*?)[\$]?(\d+[,.]?\d*\.?\d+)/gis,
          /(\d{4,8})\s*([A-Z]{3}.*?[A-Z]{3}\s*\d{1,2})(.*?)(\d+\.\d{2})/gis
        ];

        let trips = [];
        for (let p = 0; p < tripPatterns.length; p++) {
          trips = Array.from(text.matchAll(tripPatterns[p]));
          if (trips.length > 0) break;
        }

        const tripData = [];

        if (trips.length === 0) {
          tripTable.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-gray-500">No trip data found. The PDF format may not be supported.</td></tr>';
        } else {
          let tableHTML = '';
          for (let i = 0; i < trips.length; i++) {
            const trip = trips[i];
            const amount = parseFloat(trip[4].replace(/,/g, ''));
            tripData.push({
              trip: trip[1],
              dates: trip[2].replace(/\s+/g, ' ').trim(),
              amount: amount,
              details: trip[3].trim().replace(/\s+/g, ' ').substring(0, 100)
            });
            
            tableHTML += '<tr class="' + (i % 2 === 0 ? 'bg-gray-50' : 'bg-white') + '">';
            tableHTML += '<td class="p-3 whitespace-nowrap font-mono">' + trip[1] + '</td>';
            tableHTML += '<td class="p-3 whitespace-nowrap">' + trip[2].replace(/\s+/g, ' ').trim() + '</td>';
            tableHTML += '<td class="p-3 whitespace-nowrap font-semibold text-green-600">$' + amount.toFixed(2) + '</td>';
            tableHTML += '<td class="p-3 max-w-xs truncate">' + trip[3].trim().replace(/\s+/g, ' ').substring(0, 50) + '</td>';
            tableHTML += '</tr>';
          }
          tripTable.innerHTML = tableHTML;
        }

        renderChart(tripData);
        
        settlementData = {
          summary: {
            netEarnings: netEarnings,
            grossEarnings: grossEarnings,
            miles: miles,
            reimbursements: reimbursements,
            ratePerMile: ratePerMile,
            deductions: deductions
          },
          trips: tripData
        };

        exportBtn.disabled = false;
        exportBtn.textContent = 'Export CSV';
        exportBtn.className = 'w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors cursor-pointer';

      } catch (error) {
        console.error('Error analyzing text:', error);
        showMessage('Error analyzing PDF content. Please check if this is a valid settlement document.', 'error');
      }
    }

    function renderChart(trips) {
      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
      }

      const ctx = document.getElementById('earningsChart').getContext('2d');
      
      if (chartInstance) {
        chartInstance.destroy();
      }

      if (trips.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.fillText('No trip data to display', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
      }

      try {
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: trips.map(function(t) { return 'Trip ' + t.trip; }),
            datasets: [{
              label: 'Trip Earnings ($)',
              data: trips.map(function(t) { return t.amount; }),
              backgroundColor: '#3b82f6',
              borderColor: '#1d4ed8',
              borderWidth: 1,
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '$' + context.parsed.y.toFixed(2);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toFixed(0);
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error creating chart:', error);
      }
    }

    function exportCSV() {
      if (!settlementData) {
        showMessage('No data to export. Please upload a PDF first.', 'error');
        return;
      }

      try {
        const csvRows = ['Trip,Dates,Amount,Details'];

        for (let i = 0; i < settlementData.trips.length; i++) {
          const trip = settlementData.trips[i];
          const row = [
            trip.trip,
            '"' + trip.dates + '"',
            trip.amount.toFixed(2),
            '"' + trip.details.replace(/"/g, '""') + '"'
          ];
          csvRows.push(row.join(','));
        }

        csvRows.push('');
        csvRows.push('Summary');
        if (settlementData.summary.netEarnings) csvRows.push('Net Earnings,' + settlementData.summary.netEarnings.toFixed(2));
        if (settlementData.summary.grossEarnings) csvRows.push('Gross Earnings,' + settlementData.summary.grossEarnings.toFixed(2));
        if (settlementData.summary.miles) csvRows.push('Miles,' + settlementData.summary.miles);
        if (settlementData.summary.reimbursements) csvRows.push('Reimbursements,' + settlementData.summary.reimbursements.toFixed(2));

        const csv = csvRows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const fileName = 'settlement_' + new Date().toISOString().split('T')[0] + '.csv';
        saveAs(blob, fileName);
        
        showMessage('CSV exported successfully!', 'success');
      } catch (error) {
        console.error('Error exporting CSV:', error);
        showMessage('Error exporting CSV file.', 'error');
      }
    }
  </script>
</body>
</html>
